<head>
	<link rel="stylesheet" href="../node_modules/@fortawesome/fontawesome-free/css/all.min.css">
	<link rel="stylesheet" href="./css/fonts.css">
	<link rel="stylesheet" href="./css/style.css">
	<link rel="stylesheet" type="text/css" href="/assets/css/harvester.css">
	<style>
		.control {
			font-size: 14px;
		
		}

		.banner, .control {
			min-height: 35px;
		}

		 .input {
			height: 6vh;
			font-size: 3vh;
		}

		.label {
			height: 3vh;
			font-size: 2vh;
		}


		.container {
			margin: 7.5px 0
		}
		input[disabled="true"] {
			opacity: 1 !important
		}
	</style>
	<script type="text/javascript" src="https://songbird.cardinalcommerce.com/edge/v1/songbird.js"></script>
	
</head>

<body>
	<div id="banner" class="banner">
		<div class="banner banner-logo"></div>
		<div class="banner banner-draggable"></div>
		<div class="banner banner-controls">
			<div id="reloadApp" class="control"></div>
			<div id="minimizeApp" class="control">
				<i class="fas fa-window-minimize"></i>
			</div>
			<div id="closeApp" class="control">
				<i class="fas fa-times"></i>
			</div>
		</div>
	</div>
	<div class="container container-pages">
		<div class="page">
			<div class="container header-container">
				<h1 class="header-title">3DS Solver</h1>
			</div>
		
			<div class="panel panel-invisible">
				<div class="container">
					<label for="profile_name" class="label">Profile Name</label>
					<input id="profile_name" type="text" class="input" disabled="true" value="Rev Master Main"/>
				</div>
				<div class="container">
					<label for="task_id" class="label">Task ID</label>
					<input id="task_Id" type="text" class="input" disabled="true"/>
				</div>
				<div class="container">
					<label for="cardinal_id" class="label">Transaction ID</label>
					<input id="cardinal_id" class="input" type="text" value="" disabled="true"/>
				</div>
				<!-- <button id="manual">Click Here if Done</button> -->
			</div>
		</div>
	</div>
	<script>
		const electron = require('electron');
		const ipcThreeDS = electron.ipcRenderer;
		let cardinalId = document.getElementById('cardinal_id');
		let taskId = document.getElementById('task_Id');
		let profileName = document.getElementById('profile_name');

		document.getElementById('minimizeApp').onclick = function() {
			electron.remote.getCurrentWindow().minimize();
		}

		document.getElementById('closeApp').onclick = function() {
			electron.remote.getCurrentWindow().close();
		}


		function setupCompleteHandler(setupCompleteData) {
			if (setupCompleteData) {
				cardinalId.value = setupCompleteData.sessionId;
			}
			
			ipcThreeDS.send(`cardinal.setupComplete`, {
				taskId: taskId.value,
				cardinalId: cardinalId.value
			});
		}

		function validatedHandler(decodedResponseData, responseJWT) {
			console.log(arguments)
			ipcThreeDS.send('cardinal.validated', {
				taskId: taskId.value,
				data: decodedResponseData || null,
				responseJWT: responseJWT || null
			});
		}
		
		//Fired when Initial JWT is successfuuly submitted
		Cardinal.on("payments.setupComplete", setupCompleteHandler);

		//Fired when Authenication Process is completed
		Cardinal.on("payments.validated", validatedHandler);

		
		ipcThreeDS.on('cardinal.setup', (event, args) => {
			console.log('[IPC]', 'cardinal.setup', '\n', args);
			taskId.value = args.taskId;
			profileName.value = args.profile;
			Cardinal.setup("init", { jwt: args.jwt });
		})

		ipcThreeDS.on('cardinal.continue', (event, args) => {
			console.log('[IPC]', 'cardinal.continue', '\n', args);
			Cardinal.continue("cca", args.cardData, args.cardOData);
		})
		
		
		// document.getElementById('manual').onclick = setupCompleteHandler;

	</script>
</body>