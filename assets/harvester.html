<!DOCTYPE html>

<head>
	<title>XXXAIO - Captcha Harvester</title>
	<script src="https://kit.fontawesome.com/e8b782485e.js"></script>
	<link rel="stylesheet" type="text/css" href="/assets/css/style.css">
	<link rel="stylesheet" type="text/css" href="/assets/css/harvester.css">
</head>

<body id="body" onload="">
	<div id="banner" class="banner">
		<div class="banner banner-logo" style="display:none"></div>
		<div class="banner banner-nav banner-draggable">
		</div>
		<div id="minimize" class="control">
			<i class="fas fa-window-minimize"></i>
		</div>
		<div id="close" class="control">
			<i class="fas fa-times"></i>
		</div>
	</div>
	</div>

	<div class="container container-pages">
		<div class="page">
			<div class="header-container">
				<h1 class="header-title">Captcha Harvester</h1>
			</div>

			<div class="panel panel-main" id="content">
				<div class="container">
					<div id="panel-renderer" class="panel panel-light">
						<h2 class="panel-title">
							<i></i>
							<span>Solver</span>
						</h2>
						<div id="captcha-placeholder" class="container-element"></div>

					</div>
					<input id="taskId" type="hidden">
					<input id="sessionName" type="hidden">
				</div>
				<!-- <h2 class="panel-title">
					<i></i>
					<div><span>Task In Queue: </span>4</div>
				</h2> -->
				<div class="container">
					<div class="container-element container-element-lg">
						<button id="clearQueue" class="btn">Clear Queue</button>
					</div>
				</div>
			
			</div>
		</div>

	</div>

	<script>
		const electron = require('electron')
		const { remote } = electron;
		const ipcHarvester = electron.ipcRenderer;
		const $ = require('jquery');
		const settings = require('electron-settings');

		let captchaQueue = [];
		let isSolving = false;
		let alreadyUsed = false;
		let captchaSpinner = document.createElement('i');
		captchaSpinner.className = 'fas fa-spinner fa-pulse';


		let closeBtn = document.getElementById('close');
		let minimizeBtn = document.getElementById('minimize');
		let reloadBtn = document.getElementById('reload');


		let accountData = settings.has('captcha-sessions') ? settings.get('captcha-sessions') : [];
		$('.captchaAccount-selector').each(function () {
			$(this).find('option').remove().end();
		});

		for (let i = 0; i < accountData.length; i++) {
			let option = $('<option></option>');
			option.prop({
				label: accountData[i],
				value: accountData[i]
			})
			option.appendTo('.captchaAccount-selector');
		};

		// document.getElementById('saveHarvesterSettings').onclick = function() {
		// 	ipcHarvester.send('captcha change settings', {
		// 		account: document.getElementById('googleAccount').value,
		// 		proxy: document.getElementById('captchaProxy').value
		// 	})
		// }

		function sendToken() {
			console.log('SENDING TOKEN')
			ipcHarvester.send('captcha.response', {
				sessionName: config.sessionName,
				site: config.site,
				id: document.getElementById('taskId').value,
				ts: Date.now() - 5000,
				token: grecaptcha.getResponse(),
				//	sessionName: document.getElementById('sessionName').value
			});

			document.getElementById('captcha-placeholder').innerHTML = '';
			document.getElementById('captcha-placeholder').appendChild(captchaSpinner);
		}
		let config;
		async function onloadCallback() {
			let data = await fetch('/config');
			config = await data.json();
			
			ipcHarvester.on('captcha request', (event, args) => {
				document.getElementById('taskId').value = args.id;
				//	document.getElementById('sessionName').value = options.sessionName;
				document.getElementById('captcha-placeholder').innerHTML = '';
				if (!alreadyUsed) {
					let options = {
						sitekey: args.config.key,
						callback: 'sendToken',
						size: 'invisible',
						badge: 'inline'
						//theme: 'dark'
					}
					grecaptcha.render('captcha-placeholder', options);
					alreadyUsed = true;
				}
				else {
					grecaptcha.reset();
				}
				let clickBox = setInterval(() => {
					// let captchaFrame = document.querySelector('[role="presentation"]'),
					// 	captchaDocument = captchaFrame.contentDocument || captchaFrame.contentWindow.document,
					// 	captchaBox = captchaDocument.getElementsByClassName('recaptcha-checkbox-checkmark');
					// if (captchaBox[0]) {
					// 	clearInterval(clickBox);
					// 	captchaBox[0].click();
					// }
					grecaptcha.execute();
				}, 150)
			})
			document.getElementById('captcha-placeholder').appendChild(captchaSpinner);
			ipcHarvester.send('captcha.ready', {
				sessionName: config.sessionName,
				site: config.site
			});
			closeBtn.addEventListener('click', function() {
				ipcHarvester.send('captcha.closeWindow', {
					sessionName: config.sessionName,
					site: config.site
				});
			})
		}
		
		document.getElementById('clearQueue').onclick = function() {
			console.log(config)
			ipcHarvester.send('captcha.clearQueue', config.site)

		}
		ipcHarvester.on('cleared queue', (event, args) => {
			console.log(args)
		})
		minimizeBtn.addEventListener('click', () => remote.getCurrentWindow().minimize());


	</script>
	<script src="https://www.google.com/recaptcha/api.js?onload=onloadCallback&render=explicit" async defer>
	</script>
</body>